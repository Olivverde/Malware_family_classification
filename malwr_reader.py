import os
import pefile

# Define la carpeta donde se almacenan los archivos maliciosos
folder_path = "MALWR/"

# Crea una lista vacía para almacenar la información de cada archivo
malware_data = []

# Recorre todos los archivos en la carpeta
for filename in os.listdir(folder_path):
    if filename != '.DS_Store':  # Solo procesa archivos ejecutables
        file_path = os.path.join(folder_path, filename)
        pe = pefile.PE(file_path)

        # Extrae la información del PE header
        pe_header = {}
        pe_header['ImageBase'] = pe.OPTIONAL_HEADER.ImageBase
        pe_header['SectionAlignment'] = pe.OPTIONAL_HEADER.SectionAlignment
        # Agrega más campos según sea necesario

        # Extrae información de las secciones
        sections = []
        for section in pe.sections:
            section_data = {}
            section_data['Name'] = section.Name.decode('utf-8').rstrip('\x00')
            section_data['VirtualAddress'] = hex(section.VirtualAddress)
            section_data['VirtualSize'] = hex(section.Misc_VirtualSize)
            # Agrega más campos según sea necesario
            sections.append(section_data)

        # Extrae información de las llamadas
        imports = []
        for entry in pe.DIRECTORY_ENTRY_IMPORT:
            import_data = {}
            import_data['DLL'] = entry.dll.decode('utf-8').rstrip('\x00')
            import_data['Functions'] = []
            for function in entry.imports:
                import_data['Functions'].append(function.name.decode('utf-8'))
            imports.append(import_data)
	
        # Agrega la información del malware a la lista
        malware_data.append({
            'Filename': filename,
            'PEHeader': pe_header,
            'Sections': sections,
            'Imports': imports
        })

# Guarda los datos en un archivo CSV
import csv

with open('malware_dataset.csv', mode='w', newline='') as file:
    writer = csv.writer(file)
    writer.writerow(['Filename', 'PEHeader', 'Sections', 'Imports'])
    for malware in malware_data:
        writer.writerow([malware['Filename'], malware['PEHeader'], malware['Sections'], malware['Imports']])
